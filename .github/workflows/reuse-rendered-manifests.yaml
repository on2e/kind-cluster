on:
  workflow_call:
    inputs:
      name:
        type: string
        required: true

env:
  MANIFEST: deployments/${{ inputs.name }}/install.yaml
  PR_BRANCH: rendered-manifests/${{ inputs.name }}

jobs:
  render-manifest:
    if: github.ref_type == 'branch'
    permissions:
      contents: write
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0

      - name: Install Kustomize
        env:
          # renovate: datasource=github-releases packageName=kubernetes-sigs/kustomize extractVersion=^kustomize/(?<version>.+)$
          KUSTOMIZE_VERSION: v5.8.1
        run: |
          curl -sSfLO "https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize/${KUSTOMIZE_VERSION}/kustomize_${KUSTOMIZE_VERSION}_linux_amd64.tar.gz"
          tar -xzf "kustomize_${KUSTOMIZE_VERSION}_linux_amd64.tar.gz"
          chmod +x kustomize
          sudo mv kustomize /usr/bin/kustomize
        working-directory: ${{ runner.temp }}

      - name: Render manifest
        run: |
          echo "# THIS FILE WAS AUTOMATICALLY GENERATED. DO NOT EDIT." > "$MANIFEST"
          kustomize build deployments/${{ inputs.name }}/base >> "$MANIFEST"

      - name: Check if PR already exists
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr list --base "$GITHUB_REF_NAME" --head "$PR_BRANCH" --json number,title,url > pr.json
          PR_EXISTS="$(! jq -e 'isempty(.[])' pr.json >/dev/null && echo "true" || echo "false")"
          echo "PR_EXISTS=$PR_EXISTS" >> "$GITHUB_ENV"
          if [[ "$PR_EXISTS" = "true" ]]; then
            echo -e "A pull request for branch '$PR_BRANCH' into branch '$GITHUB_REF_NAME' already exists:\n$(jq '.[0]' pr.json)"
          fi
          rm -rf pr.json

      - name: Push changes and create/update PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          if [[ -z "$(git status --porcelain -- "$MANIFEST")" ]]; then
            echo "No changes to '$MANIFEST' on branch '$GITHUB_REF_NAME'"
            if [[ "$PR_EXISTS" = "true" ]]; then
              echo "Closing existing pull request and deleting branch '$PR_BRANCH'"
              gh pr comment "$PR_BRANCH" --body "Closing this PR because manifest is up to date on base branch."
              gh pr close "$PR_BRANCH" --delete-branch
            fi
            exit 0
          fi

          if git show-ref --verify --quiet "refs/remotes/origin/$PR_BRANCH"; then
            echo "Remote branch '$PR_BRANCH' already exists, will rebase and force-push if behind base branch"
            # Copy manifest outside of git
            MANIFEST_TEMP="$(mktemp)" && cp "$MANIFEST" "$MANIFEST_TEMP"
            # Reset working tree in order to switch branches
            git reset --hard && git clean -dfx
            # Create a local branch just like the remote-tracking branch
            git checkout -b "$PR_BRANCH" "origin/$PR_BRANCH"
            # Rebase PR branch onto base branch to keep PR up to date
            git rebase "$GITHUB_REF_NAME"
            # Move manifest on the PR branch
            mv "$MANIFEST_TEMP" "$MANIFEST"
            if [[ -z "$(git status --porcelain -- "$MANIFEST")" ]]; then
              echo "No changes to '$MANIFEST' on branch '$PR_BRANCH'"
              exit 0
            fi
          else
            git checkout -b "$PR_BRANCH"
          fi

          COMMIT_SHA_SHORT="$(git rev-parse --short "$GITHUB_SHA")"
          COMMIT_MSG="${{ inputs.name }}: Render manifest at $COMMIT_SHA_SHORT"
          PR_BODY="This PR renders manifest $MANIFEST at $COMMIT_SHA_SHORT."

          git add "$MANIFEST"
          git commit -s -m "$COMMIT_MSG"
          git push -f origin "$PR_BRANCH"

          if [[ "$PR_EXISTS" != "true" ]]; then
            gh pr create --base "$GITHUB_REF_NAME" --head "$PR_BRANCH" --title "$COMMIT_MSG" --body "$PR_BODY"
          else
            gh pr edit "$PR_BRANCH" --title "$COMMIT_MSG" --body "$PR_BODY"
          fi
